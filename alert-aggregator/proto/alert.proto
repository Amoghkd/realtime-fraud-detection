syntax = "proto3";

package fraud_detection.alerts;

import "google/protobuf/timestamp.proto";

// Unified Alert Schema - Canonical format for all fraud alerts
message UnifiedAlert {
  // Core identification
  string alert_id = 1;                    // UUID for the unified alert
  string transaction_id = 2;              // Original transaction ID
  
  // Alert classification
  AlertType alert_type = 3;
  AlertSeverity severity = 4;
  AlertStatus status = 5;
  
  // Transaction details
  TransactionInfo transaction = 6;
  
  // Detection details
  DetectionInfo detection = 7;
  
  // Risk assessment
  RiskAssessment risk = 8;
  
  // Temporal information
  google.protobuf.Timestamp created_at = 9;
  google.protobuf.Timestamp updated_at = 10;
  google.protobuf.Timestamp expires_at = 11;
  
  // Metadata
  map<string, string> metadata = 12;
  repeated string tags = 13;
  
  // Processing info
  ProcessingInfo processing = 14;
}

enum AlertType {
  ALERT_TYPE_UNSPECIFIED = 0;
  RULE_HIGH_VALUE = 1;
  RULE_VELOCITY = 2;
  RULE_IMPOSSIBLE_TRAVEL = 3;
  RULE_SUSPICIOUS_MERCHANT = 4;
  ML_FRAUD_DETECTION = 5;
  COMPOSITE_MULTI_RULE = 6;
}

enum AlertSeverity {
  SEVERITY_UNSPECIFIED = 0;
  LOW = 1;
  MEDIUM = 2;
  HIGH = 3;
  CRITICAL = 4;
}

enum AlertStatus {
  STATUS_UNSPECIFIED = 0;
  ACTIVE = 1;
  ACKNOWLEDGED = 2;
  INVESTIGATING = 3;
  RESOLVED = 4;
  FALSE_POSITIVE = 5;
}

message TransactionInfo {
  string transaction_id = 1;
  double amount = 2;
  string currency = 3;
  string card_id = 4;
  string user_id = 5;
  string merchant_id = 6;
  string merchant_name = 7;
  string merchant_category = 8;
  string payment_method = 9;
  Location location = 10;
  google.protobuf.Timestamp timestamp = 11;
}

message Location {
  double latitude = 1;
  double longitude = 2;
  string city = 3;
  string country = 4;
  string ip_address = 5;
}

message DetectionInfo {
  string detection_method = 1;           // "rule_engine", "ml_model", "composite"
  string rule_name = 2;                  // Name of triggered rule
  string model_version = 3;              // ML model version if applicable
  double confidence_score = 4;           // 0.0 to 1.0
  string reason = 5;                     // Human-readable explanation
  repeated string triggered_rules = 6;   // List of all triggered rules
  map<string, double> feature_scores = 7; // Feature importance scores
}

message RiskAssessment {
  double overall_risk_score = 1;         // 0.0 to 1.0
  double merchant_risk = 2;
  double location_risk = 3;
  double velocity_risk = 4;
  double amount_risk = 5;
  double behavioral_risk = 6;
  string risk_factors = 7;               // JSON array of risk factors
}

message ProcessingInfo {
  string source_topic = 1;               // Original Kafka topic
  string aggregator_version = 2;         // Version of aggregator
  int32 merge_count = 3;                 // Number of alerts merged
  repeated string source_alert_ids = 4;  // Original alert IDs that were merged
  google.protobuf.Timestamp processed_at = 5;
  string processing_node = 6;            // Hostname/ID of processing node
}
