input {
  kafka {
    bootstrap_servers => "kafka:9094"
    topics => ["alerts.high_value", "alerts.velocity", "alerts.impossible_travel", "alerts.ml.v1"]
    group_id => "fraud_alerts_group"
    auto_offset_reset => "earliest"
    codec => "json"
  }
}

filter {
  # Drop low-value alerts to reduce noise
  if [alert_type] == "HIGH_VALUE" and [amount] < 5000 {
    drop { }
  }

  # Ensure timestamp field
  if ![event_time] {
    mutate {
      add_field => { "event_time" => "%{@timestamp}" }
    }
  }

  # Aggregate per card_id
  aggregate {
    task_id => "%{card_id}"
    code => "
      map['alerts'] ||= []
      map['alerts'] << event.to_hash
      event.cancel()
    "
    push_map_as_event_on_timeout => true
    timeout => 60
    timeout_tags => ["aggregated"]
    timeout_code => "
      event.set('card_id', map['alerts'][0]['card_id'])
      event.set('alerts', map['alerts'])
      event.set('alert_count', map['alerts'].size)
    "
  }
}

output {
  stdout { codec => rubydebug }

  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "fraud-alerts-%{+YYYY.MM.dd}"
  }
}
